<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeFeel v0.7</title>
  <style>
    :root { color-scheme: dark; }

    /* iOS Safari: long-press kopyala/callout + seçimi kapat */
    * { -webkit-tap-highlight-color: transparent; }
    html, body {
      height:100%;
      margin:0;
      background:#0b0d12;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    .wrap { min-height:100%; display:flex; align-items:center; justify-content:center; padding:18px; }
    .card{
      width:min(760px, 96vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      box-shadow: 0 10px 40px rgba(0,0,0,0.35);
      padding:16px;
      user-select:none;
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }

    .top { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .brand { font-size:12px; opacity:.65; letter-spacing:.16em; text-transform:uppercase; }
    .goalLine { font-size:14px; font-weight:850; }
    .muted { opacity:.65; }

    .tabs { display:flex; gap:8px; }
    .chip{
      appearance:none;
      border-radius:999px;
      padding:8px 12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.92);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(78,163,255,0.35);
      background: rgba(78,163,255,0.12);
    }

    .stats { display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      white-space:nowrap;
      opacity:.92;
    }

    .arena{
      margin-top:12px;
      height:320px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.08);
      background: radial-gradient(1200px 520px at 50% 0%, rgba(78,163,255,0.10), rgba(255,255,255,0.01));
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
      touch-action:none;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    .orb{
      width:150px; height:150px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-weight:950; letter-spacing:0.08em;
      border:1px solid rgba(78,163,255,0.35);
      background: rgba(78,163,255,0.10);
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease;
      box-shadow: 0 0 0 0 rgba(78,163,255,0.0);
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    .orb *{
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    .orb.holding{
      transform: scale(1.06);
      background: rgba(78,163,255,0.18);
      box-shadow: 0 0 0 20px rgba(78,163,255,0.06);
    }

    .toast{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:44px; font-weight:950;
      opacity:0; transform: translateY(8px);
      transition: opacity 160ms ease, transform 160ms ease;
      pointer-events:none;
      text-shadow: 0 12px 40px rgba(0,0,0,0.6);
      -webkit-user-select:none;
      user-select:none;
    }
    .toast.show{ opacity:1; transform:translateY(0); }
    .good{ color: rgba(120,255,190,0.95); }
    .bad{ color: rgba(255,120,140,0.95); }

    .bottom{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 740px){
      .bottom{ grid-template-columns: 1fr; }
    }
    .panel{
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      padding:12px;
    }
    .panel h3{
      margin:0 0 8px 0;
      font-size:12px;
      opacity:.7;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .row { display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .big { font-size:18px; font-weight:950; }
    .btn{
      appearance:none;
      border-radius:12px;
      padding:10px 12px;
      font-weight:950;
      font-size:13px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
    }
    .btn.primary{ border-color: rgba(78,163,255,0.35); background: rgba(78,163,255,0.12); }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .lbItem{
      display:flex; justify-content:space-between; gap:10px;
      font-size:13px; padding:6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .lbItem:last-child{ border-bottom:none; }

    .confetti{
      position:absolute;
      width:8px; height:10px;
      border-radius:2px;
      opacity:0.95;
      pointer-events:none;
      transform: translateY(-20px);
      animation: fall 700ms ease-out forwards;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,0.45));
    }
    @keyframes fall { to { transform: translateY(340px) rotate(220deg); opacity:0; } }

    input[type="range"]{ width:100%; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="top">
      <div style="display:flex; flex-direction:column; gap:4px;">
        <div class="brand">TIMEFEEL</div>
        <div class="goalLine" id="goalLine">Bugünün hedefi: 1.70s (Orta)</div>
        <div class="muted" style="font-size:12px;">Basılı tut → tam hedefte bırak. (Space da olur)</div>
      </div>

      <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <div class="tabs">
          <button class="chip" id="tabDaily" type="button">Daily</button>
          <button class="chip" id="tabPractice" type="button">Practice</button>
        </div>
        <div class="tabs">
          <button class="chip" id="diffEasy" type="button">Kolay</button>
          <button class="chip" id="diffMed" type="button">Orta</button>
          <button class="chip" id="diffHard" type="button">Zor</button>
        </div>
      </div>
    </div>

    <div class="stats" style="margin-top:10px;">
      <div class="pill" id="pillLives">❤️ Hak: <span id="lives">5</span></div>
      <div class="pill">Tolerans: ±<span id="tol">80</span>ms</div>
      <div class="pill">Streak: <span id="streak">0</span></div>
      <div class="pill" id="pillBest">Bugün en iyi: <span id="best">0</span></div>
    </div>

    <div class="arena" id="arena">
      <div class="toast" id="toast">PERFECT</div>
      <div class="orb" id="orb" aria-label="Hold button">HOLD</div>
    </div>

    <div class="bottom">
      <div class="panel">
        <h3>Son Deneme</h3>
        <div class="row">
          <div class="big" id="lastYou">Sen: —</div>
          <div class="pill" id="lastGoal">Hedef: —</div>
          <div class="pill" id="lastDiff">Fark: —</div>
          <div class="pill" id="lastVerdict">—</div>
        </div>
        <div class="muted" style="margin-top:8px; font-size:12px;" id="msg">Hazır.</div>

        <div class="row" style="margin-top:10px;">
          <button class="btn" id="resetBtn" type="button">Sıfırla</button>
          <button class="btn primary" id="adBtn" type="button">+2 Hak (Reklam)</button>
        </div>

        <div id="practiceBox" style="display:none; margin-top:10px;">
          <div class="row" style="align-items:center;">
            <div class="pill">Practice hedefi: <b id="pVal">1.70s</b></div>
            <button class="btn" id="randBtn" type="button">Random</button>
          </div>
          <div style="margin-top:8px;">
            <input id="slider" type="range" min="1.00" max="2.20" step="0.01" value="1.70" />
            <div class="muted" style="font-size:12px; margin-top:6px;">Sadece Practice’te geçerli.</div>
          </div>
        </div>
      </div>

      <div class="panel" id="lbPanel">
        <h3>Daily Leaderboard (son 7 gün)</h3>
        <div id="lb"></div>
        <div class="muted" style="font-size:12px; margin-top:8px;">Sadece bu tarayıcıda saklanır.</div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // iOS Safari: long-press context menu + selection engelle (garanti)
  window.addEventListener("contextmenu", (e) => e.preventDefault(), { passive: false });
  document.addEventListener("selectstart", (e) => e.preventDefault(), { passive: false });
  document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive: false });

  // ---------- Date key ----------
  function todayKey(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  // ---------- Deterministic RNG ----------
  function seededFloat01(seedStr){
    let h = 2166136261;
    for (let i=0;i<seedStr.length;i++){
      h ^= seedStr.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0) / 4294967296;
  }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function round2(x){ return Math.round(x*100)/100; }
  function fmt2(x){ return x.toFixed(2); }

  // ---------- Daily goals (deterministic 3-set) ----------
  function dailyGoals(){
    const base  = seededFloat01("timefeel:v07:"  + todayKey());
    const base2 = seededFloat01("timefeel:v07b:" + todayKey());
    const base3 = seededFloat01("timefeel:v07c:" + todayKey());

    const easyRaw = 1.00 + 0.60 * base;  // 1.00–1.60
    const medRaw  = 1.30 + 0.70 * base2; // 1.30–2.00
    const hardRaw = 1.55 + 0.65 * base3; // 1.55–2.20

    const snap05 = (x) => Math.round(x / 0.05) * 0.05;

    const easy = round2(clamp(snap05(easyRaw), 1.00, 1.60));
    const med  = round2(clamp(snap05(medRaw),  1.30, 2.00));
    const hard = round2(clamp(hardRaw,          1.55, 2.20));

    if (new Set([easy, med, hard]).size < 3){
      return { easy, med, hard: round2(clamp(hard + 0.01, 1.55, 2.20)) };
    }
    return { easy, med, hard };
  }
  const DAILY = dailyGoals();

  // ---------- Tolerance profiles ----------
  const TOL = {
    easy: { start: 90, min: 50, max: 150 },
    med:  { start: 80, min: 40, max: 140 },
    hard: { start: 70, min: 35, max: 130 },
  };

  // ---------- Storage ----------
  const LS = "timefeel_v07:";
  const load = (k, fb) => { try{ const v = localStorage.getItem(LS+k); return v ? JSON.parse(v) : fb; }catch{ return fb; } };
  const save = (k, v) => { try{ localStorage.setItem(LS+k, JSON.stringify(v)); }catch{} };

  // ---------- State ----------
  let mode = load("mode", "daily");          // daily | practice
  let diff = load("diff", "med");            // easy | med | hard
  if (!TOL[diff]) diff = "med";
  if (mode !== "daily" && mode !== "practice") mode = "daily";

  const LIVES_MAX = 5;
  let lives = LIVES_MAX;

  let streak = 0;
  let tolMs = TOL[diff].start;

  let practiceTarget = clamp(Number(load("practice_target", 1.70)) || 1.70, 1.00, 2.20);

  let holding = false;
  let startMs = 0;

  // best per day & diff (daily only)
  const bestKey = (d) => `best:${todayKey()}:${d}`;

  // history per diff
  let history = load("history", []);

  // ---------- DOM ----------
  const $ = (id) => document.getElementById(id);

  const tabDaily = $("tabDaily");
  const tabPractice = $("tabPractice");
  const diffEasy = $("diffEasy");
  const diffMed  = $("diffMed");
  const diffHard = $("diffHard");

  const goalLine = $("goalLine");

  const pillLives = $("pillLives");
  const livesEl = $("lives");
  const tolEl = $("tol");
  const streakEl = $("streak");
  const pillBest = $("pillBest");
  const bestEl = $("best");

  const arena = $("arena");
  const orb = $("orb");
  const toast = $("toast");

  const lastYou = $("lastYou");
  const lastGoal = $("lastGoal");
  const lastDiff = $("lastDiff");
  const lastVerdict = $("lastVerdict");
  const msg = $("msg");

  const resetBtn = $("resetBtn");
  const adBtn = $("adBtn");

  const practiceBox = $("practiceBox");
  const pVal = $("pVal");
  const randBtn = $("randBtn");
  const slider = $("slider");

  const lbPanel = $("lbPanel");
  const lb = $("lb");

  // extra: prevent long-press menu specifically on arena/orb
  [arena, orb].forEach(el => {
    el.addEventListener("contextmenu", e => e.preventDefault(), { passive:false });
    el.addEventListener("selectstart", e => e.preventDefault(), { passive:false });
  });

  // ---------- UI helpers ----------
  function showToast(text, good){
    toast.textContent = text;
    toast.className = "toast show " + (good ? "good" : "bad");
    setTimeout(()=> toast.className="toast", 420);
  }
  function setHolding(on){
    orb.classList.toggle("holding", on);
    orb.textContent = on ? "…" : "HOLD";
  }
  function signedMs(x){
    const n = Math.round(x);
    return (n >= 0 ? "+" : "") + n + "ms";
  }
  function confettiBurst(count=14){
    const rect = arena.getBoundingClientRect();
    for (let i=0;i<count;i++){
      const el = document.createElement("div");
      el.className = "confetti";
      el.style.left = `${rect.width*(0.25 + Math.random()*0.5)}px`;
      el.style.top = `0px`;
      el.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 70%)`;
      el.style.animationDuration = `${620 + Math.random()*220}ms`;
      arena.appendChild(el);
      setTimeout(()=> el.remove(), 900);
    }
  }

  function currentGoalSec(){
    return mode === "daily" ? DAILY[diff] : practiceTarget;
  }
  function clampTol(){
    tolMs = clamp(tolMs, TOL[diff].min, TOL[diff].max);
  }
  function setActiveChips(){
    tabDaily.classList.toggle("active", mode==="daily");
    tabPractice.classList.toggle("active", mode==="practice");
    diffEasy.classList.toggle("active", diff==="easy");
    diffMed.classList.toggle("active", diff==="med");
    diffHard.classList.toggle("active", diff==="hard");
  }

  function upsertHistory(){
    const t = todayKey();
    for (const d of ["easy","med","hard"]){
      const best = load(bestKey(d), 0);
      const existing = history.find(x => x.date===t && x.diff===d);
      if (existing){
        existing.goal = DAILY[d];
        existing.best = Math.max(existing.best || 0, best);
      } else {
        history.unshift({ date:t, diff:d, goal:DAILY[d], best });
      }
    }
    const trimmed = [];
    const counts = {easy:0, med:0, hard:0};
    for (const item of history){
      if (counts[item.diff] < 7){
        trimmed.push(item);
        counts[item.diff] += 1;
      }
      if (trimmed.length >= 21) break;
    }
    history = trimmed;
    save("history", history);
  }

  function renderLB(){
    upsertHistory();
    const items = history.filter(x => x.diff===diff).slice(0,7);
    lb.innerHTML = "";
    if (!items.length){
      lb.innerHTML = '<div class="muted" style="font-size:12px;">Henüz veri yok.</div>';
      return;
    }
    for (const it of items){
      const row = document.createElement("div");
      row.className = "lbItem";
      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:900;">${it.date}</div><div class="muted">Hedef: ${fmt2(it.goal)}s</div>`;
      const right = document.createElement("div");
      right.style.fontWeight="950";
      right.textContent = String(it.best || 0);
      row.appendChild(left);
      row.appendChild(right);
      lb.appendChild(row);
    }
  }

  function resetAttemptUI(){
    lastYou.textContent = "Sen: —";
    lastGoal.textContent = "Hedef: —";
    lastDiff.textContent = "Fark: —";
    lastVerdict.textContent = "—";
  }

  function render(){
    setActiveChips();

    // show/hide sections
    pillLives.style.display = mode==="daily" ? "inline-flex" : "none";
    pillBest.style.display  = mode==="daily" ? "inline-flex" : "none";
    lbPanel.style.display   = mode==="daily" ? "block" : "none";
    adBtn.style.display     = mode==="daily" ? "inline-flex" : "none";
    practiceBox.style.display = mode==="practice" ? "block" : "none";

    // header line
    const diffLabel = diff==="easy"?"Kolay":diff==="med"?"Orta":"Zor";
    if (mode === "daily"){
      goalLine.textContent = `Bugünün hedefi: ${fmt2(DAILY[diff])}s (${diffLabel})`;
    } else {
      goalLine.textContent = `Practice hedefi: ${fmt2(practiceTarget)}s (${diffLabel})`;
    }

    livesEl.textContent = String(lives);
    tolEl.textContent = String(Math.round(tolMs));
    streakEl.textContent = String(streak);

    if (mode==="daily"){
      bestEl.textContent = String(load(bestKey(diff), 0));
      adBtn.disabled = !(lives<=0);
      renderLB();
    }

    slider.value = fmt2(practiceTarget);
    pVal.textContent = `${fmt2(practiceTarget)}s`;
  }

  function hardReset(refillLives){
    holding = false;
    setHolding(false);
    streak = 0;
    tolMs = TOL[diff].start;
    clampTol();
    if (mode==="daily" && refillLives) lives = LIVES_MAX;
    msg.textContent = "Hazır.";
    resetAttemptUI();
    render();
  }

  function setMode(newMode){
    if (newMode !== "daily" && newMode !== "practice") return;
    mode = newMode;
    save("mode", mode);
    hardReset(false);
  }

  function setDiff(newDiff){
    if (!TOL[newDiff]) return;
    diff = newDiff;
    save("diff", diff);
    hardReset(false);
  }

  function setPracticeTarget(sec){
    practiceTarget = clamp(sec, 1.00, 2.20);
    save("practice_target", practiceTarget);
    if (mode==="practice") msg.textContent = "Hedef güncellendi.";
    render();
  }

  // ---------- Input ----------
  function onPress(){
    if (holding) return;

    if (mode==="daily" && lives<=0){
      msg.textContent = "Hakkın bitti. İstersen +2 hak için reklam.";
      showToast("NO LIVES", false);
      return;
    }

    holding = true;
    startMs = performance.now();
    setHolding(true);
    msg.textContent = "Tutuyorsun…";
  }

  function onRelease(){
    if (!holding) return;
    holding = false;
    setHolding(false);

    const elapsedMs = performance.now() - startMs;
    const elapsedSec = elapsedMs / 1000;

    const goalSec = currentGoalSec();
    const goalMs = goalSec * 1000;
    const diffMs = elapsedMs - goalMs;
    const abs = Math.abs(diffMs);

    // update last attempt UI
    lastYou.textContent = `Sen: ${elapsedSec.toFixed(2)}s`;
    lastGoal.textContent = `Hedef: ${fmt2(goalSec)}s`;
    lastDiff.textContent = `Fark: ${signedMs(diffMs)}`;

    const ok = abs <= tolMs;
    const perfect = abs <= tolMs * 0.35;

    if (ok){
      streak += 1;
      if (streak % 5 === 0) tolMs -= (diff==="hard"?6:diff==="easy"?4:5);

      lastVerdict.textContent = perfect ? "PERFECT" : "NICE";
      showToast(lastVerdict.textContent, true);
      msg.textContent = "Başarılı!";

      if (perfect) confettiBurst(14);

      if (mode==="daily"){
        const k = bestKey(diff);
        const b = load(k, 0);
        if (streak > b) save(k, streak);
      }
    } else {
      streak = 0;
      tolMs += (diff==="hard"?5:diff==="easy"?3:4);

      lastVerdict.textContent = diffMs < 0 ? "EARLY" : "LATE";
      showToast(lastVerdict.textContent, false);

      if (mode==="daily"){
        lives = Math.max(0, lives - 1);
        msg.textContent = lives === 0 ? "Hakkın bitti. +2 hak için reklam opsiyonel." : "Hata. Tekrar dene.";
      } else {
        msg.textContent = "Hata. Tekrar dene.";
      }
    }

    clampTol();
    render();
  }

  // ---------- Buttons ----------
  tabDaily.addEventListener("click", ()=> setMode("daily"));
  tabPractice.addEventListener("click", ()=> setMode("practice"));

  diffEasy.addEventListener("click", ()=> setDiff("easy"));
  diffMed.addEventListener("click", ()=> setDiff("med"));
  diffHard.addEventListener("click", ()=> setDiff("hard"));

  resetBtn.addEventListener("click", ()=> hardReset(true));

  // "Rewarded ad" sim: +2 lives only when lives==0
  adBtn.addEventListener("click", ()=>{
    if (mode!=="daily" || lives>0) return;
    lives = Math.min(LIVES_MAX, lives + 2);
    msg.textContent = "+2 hak aldın.";
    showToast("+2 LIFE", true);
    render();
  });

  randBtn.addEventListener("click", ()=>{
    const r = 1.00 + (2.20 - 1.00) * Math.random();
    setPracticeTarget(round2(r));
  });
  slider.addEventListener("input", (e)=> setPracticeTarget(parseFloat(e.target.value)));

  // pointer + space
  arena.addEventListener("pointerdown", (e)=>{ e.preventDefault(); onPress(); }, { passive:false });
  window.addEventListener("pointerup", ()=> onRelease(), { passive:true });

  window.addEventListener("keydown", (e)=>{ if (e.code==="Space"){ e.preventDefault(); onPress(); } });
  window.addEventListener("keyup", (e)=>{ if (e.code==="Space"){ e.preventDefault(); onRelease(); } });

  // ---------- Init ----------
  render();
  hardReset(false);
})();
</script>
</body>
</html>
