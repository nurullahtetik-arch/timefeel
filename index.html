<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeFeel v0.9</title>

  <style>
    :root { color-scheme: dark; }
    * { -webkit-tap-highlight-color: transparent; }
    html, body {
      height:100%;
      margin:0;
      background:#070912;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      overflow-x:hidden;
    }

    /* --- Backdrop --- */
    .bg {
      position:fixed; inset:0;
      background:
        radial-gradient(1000px 700px at 20% 20%, rgba(120,120,255,0.18), transparent 60%),
        radial-gradient(1000px 700px at 80% 10%, rgba(78,163,255,0.18), transparent 55%),
        radial-gradient(900px 700px at 70% 80%, rgba(120,255,190,0.12), transparent 60%),
        radial-gradient(900px 700px at 20% 80%, rgba(255,120,200,0.10), transparent 55%),
        linear-gradient(180deg, #070912 0%, #06070e 60%, #05060b 100%);
      filter: saturate(1.08);
    }
    .grain {
      pointer-events:none;
      position:fixed; inset:0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      opacity:.045;
      mix-blend-mode: overlay;
    }

    .wrap { position:relative; min-height:100%; display:flex; align-items:center; justify-content:center; padding:18px; }

    .card{
      width:min(900px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      box-shadow: 0 22px 70px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.03) inset;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:16px;
    }

    .top { display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap; }
    .brandRow { display:flex; align-items:center; gap:10px; }
    .logo {
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: radial-gradient(18px 18px at 30% 30%, rgba(78,163,255,0.35), rgba(255,255,255,0.02));
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
      display:flex; align-items:center; justify-content:center;
    }
    .logo svg { opacity:.9; }
    .brand { font-size:12px; opacity:.65; letter-spacing:.18em; text-transform:uppercase; }
    .headline { margin-top:6px; font-size:16px; font-weight:950; letter-spacing:0.01em; line-height:1.2; }
    .sub { margin-top:6px; font-size:12px; opacity:.65; line-height:1.35; }

    .controls { display:flex; flex-direction:column; gap:10px; align-items:flex-end; min-width: 300px; }
    .chipRow { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }

    .chip{
      appearance:none;
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.92);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    }
    .chip:hover { transform: translateY(-1px); }
    .chip:active { transform: translateY(0px) scale(0.99); }
    .chip.active{
      border-color: rgba(78,163,255,0.38);
      background: rgba(78,163,255,0.14);
      box-shadow: 0 10px 30px rgba(78,163,255,0.08);
    }

    .stats {
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      white-space:nowrap;
      opacity:.94;
    }
    .pill b { font-weight:950; }
    .dot { width:6px; height:6px; border-radius:999px; background: rgba(255,255,255,0.35); }
    .dot.green { background: rgba(120,255,190,0.75); }
    .dot.blue  { background: rgba(78,163,255,0.75); }
    .dot.red   { background: rgba(255,120,140,0.80); }

    /* --- Arena --- */
    .arena{
      margin-top:14px;
      height:340px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.08);
      background:
        radial-gradient(900px 380px at 50% 0%, rgba(78,163,255,0.14), rgba(255,255,255,0.01)),
        radial-gradient(700px 420px at 50% 120%, rgba(120,255,190,0.08), transparent 65%);
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
      touch-action:none;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    }
    .orbWrap { position:relative; width:170px; height:170px; display:flex; align-items:center; justify-content:center; }
    .ring {
      position:absolute; inset:-10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.08);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.06), transparent 60%);
    }
    .orb{
      width:160px; height:160px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-weight:950; letter-spacing:0.12em;
      border:1px solid rgba(78,163,255,0.45);
      background:
        radial-gradient(circle at 30% 30%, rgba(78,163,255,0.35), rgba(78,163,255,0.10) 40%, rgba(255,255,255,0.02));
      box-shadow: 0 25px 70px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.04) inset;
      transition: transform 130ms ease, box-shadow 130ms ease, background 130ms ease;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    }
    .orb.holding{
      transform: scale(1.06);
      background:
        radial-gradient(circle at 30% 30%, rgba(78,163,255,0.50), rgba(78,163,255,0.18) 45%, rgba(255,255,255,0.03));
      box-shadow:
        0 30px 90px rgba(0,0,0,0.62),
        0 0 0 22px rgba(78,163,255,0.09);
    }
    .hint { position:absolute; bottom:14px; font-size:12px; opacity:.65; }

    .toast{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:46px; font-weight:950;
      opacity:0; transform: translateY(8px);
      transition: opacity 160ms ease, transform 160ms ease;
      pointer-events:none;
      text-shadow: 0 16px 60px rgba(0,0,0,0.70);
    }
    .toast.show{ opacity:1; transform:translateY(0); }
    .good{ color: rgba(120,255,190,0.95); }
    .bad{ color: rgba(255,120,140,0.95); }

    /* --- Bottom --- */
    .bottom{ margin-top:14px; display:grid; grid-template-columns: 1.1fr 0.9fr; gap:12px; }
    @media (max-width: 780px){
      .controls{ align-items:flex-start; min-width:auto; }
      .chipRow{ justify-content:flex-start; }
      .bottom{ grid-template-columns: 1fr; }
      .arena{ height:320px; }
    }

    .panel{
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.025);
      padding:12px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
    }
    .panel h3{
      margin:0 0 8px 0;
      font-size:12px;
      opacity:.7;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .metric { display:flex; flex-direction:column; gap:4px; min-width: 130px; }
    .metric .k { font-size:11px; opacity:.6; letter-spacing:.06em; text-transform:uppercase; }
    .metric .v { font-size:18px; font-weight:950; }

    .btn{
      appearance:none;
      border-radius:14px;
      padding:10px 12px;
      font-weight:950;
      font-size:13px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn:active { transform: translateY(0px) scale(0.99); }
    .btn.primary{
      border-color: rgba(78,163,255,0.38);
      background: rgba(78,163,255,0.14);
      box-shadow: 0 12px 40px rgba(78,163,255,0.08);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .lbItem{
      display:flex; justify-content:space-between; gap:10px;
      font-size:13px; padding:8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .lbItem:last-child{ border-bottom:none; }

    .mini { font-size:12px; opacity:.65; line-height:1.35; }
    .confetti{
      position:absolute; width:8px; height:10px; border-radius:2px; opacity:0.95; pointer-events:none;
      transform: translateY(-20px);
      animation: fall 720ms ease-out forwards;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.55));
    }
    @keyframes fall { to { transform: translateY(360px) rotate(220deg); opacity:0; } }

    input[type="range"]{ width:100%; }

    .footer {
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      opacity:.55;
    }
  </style>
</head>

<body>
  <div class="bg"></div>
  <div class="grain"></div>

  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div class="brandRow">
            <div class="logo" aria-hidden="true">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M12 2v3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 19v3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M4.93 4.93l2.12 2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M16.95 16.95l2.12 2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M2 12h3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M19 12h3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M4.93 19.07l2.12-2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M16.95 7.05l2.12-2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 7a5 5 0 1 0 0 10" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <div>
              <div class="brand">TIMEFEEL</div>
              <div class="headline" id="goalLine">Bugünün hedefi: 1.70s (Orta)</div>
            </div>
          </div>
          <div class="sub">Basılı tut → tam hedefte bırak. (Space da olur)</div>
        </div>

        <div class="controls">
          <div class="chipRow">
            <button class="chip" id="tabDaily" type="button">Daily</button>
            <button class="chip" id="tabPractice" type="button">Practice</button>
            <button class="chip" id="shareBtn" type="button">Share</button>
          </div>
          <div class="chipRow">
            <button class="chip" id="diffEasy" type="button">Kolay</button>
            <button class="chip" id="diffMed" type="button">Orta</button>
            <button class="chip" id="diffHard" type="button">Zor</button>
            <button class="chip" id="soundBtn" type="button">Ses: Açık</button>
          </div>
        </div>
      </div>

      <div class="stats">
        <div class="pill" id="pillLives"><span class="dot red"></span> ❤️ Hak: <b id="lives">5</b></div>
        <div class="pill"><span class="dot blue"></span> Tolerans: ±<b id="tol">80</b>ms</div>
        <div class="pill"><span class="dot green"></span> Streak: <b id="streak">0</b></div>
        <div class="pill" id="pillBest">Bugün en iyi: <b id="best">0</b></div>
      </div>

      <div class="arena" id="arena">
        <div class="toast" id="toast">PERFECT</div>

        <div class="orbWrap">
          <div class="ring" aria-hidden="true"></div>
          <div class="orb" id="orb" aria-label="Hold">HOLD</div>
        </div>

        <div class="hint">Basılı tut / bırak</div>
      </div>

      <div class="bottom">
        <div class="panel">
          <h3>Son deneme</h3>

          <div class="row">
            <div class="metric">
              <div class="k">Sen</div>
              <div class="v" id="lastYou">—</div>
            </div>
            <div class="metric">
              <div class="k">Hedef</div>
              <div class="v" id="lastGoal">—</div>
            </div>
            <div class="metric">
              <div class="k">Fark</div>
              <div class="v" id="lastDiff">—</div>
            </div>
            <div class="metric">
              <div class="k">Sonuç</div>
              <div class="v" id="lastVerdict">—</div>
            </div>
          </div>

          <div class="mini" style="margin-top:10px;" id="msg">Hazır.</div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="resetBtn" type="button">Sıfırla</button>
            <button class="btn primary" id="adBtn" type="button">+2 Hak (Reklam)</button>
          </div>

          <div id="practiceBox" style="display:none; margin-top:12px;">
            <div class="row" style="align-items:center;">
              <div class="pill">Practice hedefi: <b id="pVal">1.70s</b></div>
              <button class="btn" id="randBtn" type="button">Random</button>
            </div>
            <div style="margin-top:10px;">
              <input id="slider" type="range" min="1.00" max="2.20" step="0.01" value="1.70" />
              <div class="mini" style="margin-top:8px;">Slider sadece Practice’te geçerli.</div>
            </div>
          </div>
        </div>

        <div class="panel" id="lbPanel">
          <h3>Daily leaderboard</h3>
          <div id="lb"></div>
          <div class="mini" style="margin-top:10px;">Sadece bu tarayıcıda saklanır.</div>
        </div>
      </div>

      <div class="footer">
        <div>Daily: 5 hak • Practice: sınırsız • Reklam opsiyonel</div>
        <div>v0.9</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // iOS Safari: long-press context menu + selection engelle (garanti)
  window.addEventListener("contextmenu", (e) => e.preventDefault(), { passive: false });
  document.addEventListener("selectstart", (e) => e.preventDefault(), { passive: false });
  document.addEventListener("gesturestart", (e) => e.preventDefault(), { passive: false });

  // ---------- Helpers ----------
  function todayKey(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function seededFloat01(seedStr){
    let h = 2166136261;
    for (let i=0;i<seedStr.length;i++){
      h ^= seedStr.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h >>> 0) / 4294967296;
  }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function round2(x){ return Math.round(x*100)/100; }
  function fmt2(x){ return x.toFixed(2); }
  function signedMs(x){
    const n = Math.round(x);
    return (n >= 0 ? "+" : "") + n + "ms";
  }

  // ---------- Daily goals ----------
  function dailyGoals(){
    const base  = seededFloat01("timefeel:v09:"  + todayKey());
    const base2 = seededFloat01("timefeel:v09b:" + todayKey());
    const base3 = seededFloat01("timefeel:v09c:" + todayKey());

    const easyRaw = 1.00 + 0.60 * base;  // 1.00–1.60
    const medRaw  = 1.30 + 0.70 * base2; // 1.30–2.00
    const hardRaw = 1.55 + 0.65 * base3; // 1.55–2.20

    const snap05 = (x) => Math.round(x / 0.05) * 0.05;

    const easy = round2(clamp(snap05(easyRaw), 1.00, 1.60));
    const med  = round2(clamp(snap05(medRaw),  1.30, 2.00));
    const hard = round2(clamp(hardRaw,          1.55, 2.20));

    if (new Set([easy, med, hard]).size < 3){
      return { easy, med, hard: round2(clamp(hard + 0.01, 1.55, 2.20)) };
    }
    return { easy, med, hard };
  }
  const DAILY = dailyGoals();

  // ---------- Tolerance profiles ----------
  const TOL = {
    easy: { start: 90, min: 50, max: 150 },
    med:  { start: 80, min: 40, max: 140 },
    hard: { start: 70, min: 35, max: 130 },
  };

  // ---------- Storage ----------
  const LS = "timefeel_v09:";
  const load = (k, fb) => { try{ const v = localStorage.getItem(LS+k); return v ? JSON.parse(v) : fb; }catch{ return fb; } };
  const save = (k, v) => { try{ localStorage.setItem(LS+k, JSON.stringify(v)); }catch{} };

  // ---------- State ----------
  let mode = load("mode", "daily");          // daily | practice
  let diff = load("diff", "med");            // easy | med | hard
  if (!TOL[diff]) diff = "med";
  if (mode !== "daily" && mode !== "practice") mode = "daily";

  const LIVES_MAX = 5;
  let lives = LIVES_MAX;

  let streak = 0;
  let tolMs = TOL[diff].start;

  let practiceTarget = clamp(Number(load("practice_target", 1.70)) || 1.70, 1.00, 2.20);

  let holding = false;
  let startMs = 0;

  const bestKey = (d) => `best:${todayKey()}:${d}`;
  let history = load("history", []);

  // ---------- Sound ----------
  let soundOn = load("sound_on", true);
  let audioCtx = null;

  function ensureAudio(){
    if (!soundOn) return null;
    if (!audioCtx){
      try{ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      catch{ audioCtx = null; }
    }
    if (audioCtx && audioCtx.state === "suspended"){
      audioCtx.resume().catch(()=>{});
    }
    return audioCtx;
  }

  function tone(freq, dur, type="sine", gain=0.06){
    const ctx = ensureAudio();
    if (!ctx) return;

    const t0 = ctx.currentTime;
    const osc = ctx.createOscillator();
    const g = ctx.createGain();

    osc.type = type;
    osc.frequency.setValueAtTime(freq, t0);

    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(gain, t0 + 0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + dur);

    osc.connect(g);
    g.connect(ctx.destination);

    osc.start(t0);
    osc.stop(t0 + dur + 0.02);
  }

  function sPress(){ tone(180, 0.07, "sine", 0.05); }
  function sNice(){ tone(520, 0.08, "triangle", 0.06); tone(760, 0.09, "triangle", 0.035); }
  function sPerfect(){ tone(620, 0.08, "triangle", 0.06); setTimeout(()=>tone(880, 0.10, "triangle", 0.05), 60); }
  function sFail(){ tone(140, 0.10, "sawtooth", 0.045); setTimeout(()=>tone(110, 0.10, "sawtooth", 0.035), 70); }
  function sSwitch(){ tone(320, 0.05, "sine", 0.04); }

  // ---------- DOM ----------
  const $ = (id) => document.getElementById(id);

  const tabDaily = $("tabDaily");
  const tabPractice = $("tabPractice");
  const shareBtn = $("shareBtn");
  const soundBtn = $("soundBtn");

  const diffEasy = $("diffEasy");
  const diffMed  = $("diffMed");
  const diffHard = $("diffHard");

  const goalLine = $("goalLine");

  const pillLives = $("pillLives");
  const livesEl = $("lives");
  const tolEl = $("tol");
  const streakEl = $("streak");
  const pillBest = $("pillBest");
  const bestEl = $("best");

  const arena = $("arena");
  const orb = $("orb");
  const toast = $("toast");

  const lastYou = $("lastYou");
  const lastGoal = $("lastGoal");
  const lastDiff = $("lastDiff");
  const lastVerdict = $("lastVerdict");
  const msg = $("msg");

  const resetBtn = $("resetBtn");
  const adBtn = $("adBtn");

  const practiceBox = $("practiceBox");
  const pVal = $("pVal");
  const randBtn = $("randBtn");
  const slider = $("slider");

  const lbPanel = $("lbPanel");
  const lb = $("lb");

  [arena, orb].forEach(el => {
    el.addEventListener("contextmenu", e => e.preventDefault(), { passive:false });
    el.addEventListener("selectstart", e => e.preventDefault(), { passive:false });
  });

  // ---------- UI helpers ----------
  function showToast(text, good){
    toast.textContent = text;
    toast.className = "toast show " + (good ? "good" : "bad");
    setTimeout(()=> toast.className="toast", 420);
  }
  function setHolding(on){
    orb.classList.toggle("holding", on);
    orb.textContent = on ? "…" : "HOLD";
  }
  function confettiBurst(count=14){
    const rect = arena.getBoundingClientRect();
    for (let i=0;i<count;i++){
      const el = document.createElement("div");
      el.className = "confetti";
      el.style.left = `${rect.width*(0.25 + Math.random()*0.5)}px`;
      el.style.top = `0px`;
      el.style.background = `hsl(${Math.floor(Math.random()*360)} 90% 70%)`;
      el.style.animationDuration = `${640 + Math.random()*240}ms`;
      arena.appendChild(el);
      setTimeout(()=> el.remove(), 950);
    }
  }
  function currentGoalSec(){ return mode === "daily" ? DAILY[diff] : practiceTarget; }
  function clampTol(){ tolMs = clamp(tolMs, TOL[diff].min, TOL[diff].max); }
  function setActiveChips(){
    tabDaily.classList.toggle("active", mode==="daily");
    tabPractice.classList.toggle("active", mode==="practice");
    diffEasy.classList.toggle("active", diff==="easy");
    diffMed.classList.toggle("active", diff==="med");
    diffHard.classList.toggle("active", diff==="hard");
    soundBtn.classList.toggle("active", soundOn);
    soundBtn.textContent = soundOn ? "Ses: Açık" : "Ses: Kapalı";
  }

  function upsertHistory(){
    const t = todayKey();
    for (const d of ["easy","med","hard"]){
      const best = load(bestKey(d), 0);
      const existing = history.find(x => x.date===t && x.diff===d);
      if (existing){
        existing.goal = DAILY[d];
        existing.best = Math.max(existing.best || 0, best);
      } else {
        history.unshift({ date:t, diff:d, goal:DAILY[d], best });
      }
    }
    const trimmed = [];
    const counts = {easy:0, med:0, hard:0};
    for (const item of history){
      if (counts[item.diff] < 7){
        trimmed.push(item);
        counts[item.diff] += 1;
      }
      if (trimmed.length >= 21) break;
    }
    history = trimmed;
    save("history", history);
  }

  function renderLB(){
    upsertHistory();
    const items = history.filter(x => x.diff===diff).slice(0,7);
    lb.innerHTML = "";
    if (!items.length){
      lb.innerHTML = '<div class="mini">Henüz veri yok.</div>';
      return;
    }
    for (const it of items){
      const row = document.createElement("div");
      row.className = "lbItem";
      const left = document.createElement("div");
      left.innerHTML = `<div style="font-weight:950;">${it.date}</div><div class="mini" style="opacity:.65;">Hedef: ${fmt2(it.goal)}s</div>`;
      const right = document.createElement("div");
      right.style.fontWeight="950";
      right.textContent = String(it.best || 0);
      row.appendChild(left);
      row.appendChild(right);
      lb.appendChild(row);
    }
  }

  function resetAttemptUI(){
    lastYou.textContent = "—";
    lastGoal.textContent = "—";
    lastDiff.textContent = "—";
    lastVerdict.textContent = "—";
  }

  function render(){
    setActiveChips();

    const diffLabel = diff==="easy"?"Kolay":diff==="med"?"Orta":"Zor";
    if (mode === "daily"){
      goalLine.textContent = `Bugünün hedefi: ${fmt2(DAILY[diff])}s (${diffLabel})`;
    } else {
      goalLine.textContent = `Practice hedefi: ${fmt2(practiceTarget)}s (${diffLabel})`;
    }

    pillLives.style.display = mode==="daily" ? "inline-flex" : "none";
    pillBest.style.display  = mode==="daily" ? "inline-flex" : "none";
    lbPanel.style.display   = mode==="daily" ? "block" : "none";
    adBtn.style.display     = mode==="daily" ? "inline-flex" : "none";
    practiceBox.style.display = mode==="practice" ? "block" : "none";

    livesEl.textContent = String(lives);
    tolEl.textContent = String(Math.round(tolMs));
    streakEl.textContent = String(streak);

    if (mode==="daily"){
      bestEl.textContent = String(load(bestKey(diff), 0));
      adBtn.disabled = !(lives<=0);
      renderLB();
    }

    slider.value = fmt2(practiceTarget);
    pVal.textContent = `${fmt2(practiceTarget)}s`;
  }

  function hardReset(refillLives){
    holding = false;
    setHolding(false);
    streak = 0;
    tolMs = TOL[diff].start;
    clampTol();
    if (mode==="daily" && refillLives) lives = LIVES_MAX;
    msg.textContent = "Hazır.";
    resetAttemptUI();
    render();
  }

  function setMode(newMode){
    if (newMode !== "daily" && newMode !== "practice") return;
    mode = newMode;
    save("mode", mode);
    sSwitch();
    hardReset(false);
  }

  function setDiff(newDiff){
    if (!TOL[newDiff]) return;
    diff = newDiff;
    save("diff", diff);
    sSwitch();
    hardReset(false);
  }

  function setPracticeTarget(sec){
    practiceTarget = clamp(sec, 1.00, 2.20);
    save("practice_target", practiceTarget);
    if (mode==="practice") msg.textContent = "Hedef güncellendi.";
    render();
  }

  // ---------- Gameplay ----------
  function onPress(){
    ensureAudio(); // unlock on first interaction
    if (holding) return;

    if (mode==="daily" && lives<=0){
      msg.textContent = "Hakkın bitti. İstersen +2 hak için reklam.";
      showToast("NO LIVES", false);
      sFail();
      return;
    }

    holding = true;
    startMs = performance.now();
    setHolding(true);
    msg.textContent = "Tutuyorsun…";
    sPress();
  }

  function onRelease(){
    if (!holding) return;
    holding = false;
    setHolding(false);

    const elapsedMs = performance.now() - startMs;
    const elapsedSec = elapsedMs / 1000;

    const goalSec = currentGoalSec();
    const goalMs = goalSec * 1000;
    const diffMs = elapsedMs - goalMs;
    const abs = Math.abs(diffMs);

    lastYou.textContent = `${elapsedSec.toFixed(2)}s`;
    lastGoal.textContent = `${fmt2(goalSec)}s`;
    lastDiff.textContent = signedMs(diffMs);

    const ok = abs <= tolMs;
    const perfect = abs <= tolMs * 0.35;

    if (ok){
      streak += 1;
      if (streak % 5 === 0) tolMs -= (diff==="hard"?6:diff==="easy"?4:5);

      lastVerdict.textContent = perfect ? "PERFECT" : "NICE";
      showToast(lastVerdict.textContent, true);
      msg.textContent = "Başarılı!";
      if (perfect){ confettiBurst(14); sPerfect(); }
      else { sNice(); }

      if (mode==="daily"){
        const k = bestKey(diff);
        const b = load(k, 0);
        if (streak > b) save(k, streak);
      }
    } else {
      streak = 0;
      tolMs += (diff==="hard"?5:diff==="easy"?3:4);

      lastVerdict.textContent = diffMs < 0 ? "EARLY" : "LATE";
      showToast(lastVerdict.textContent, false);
      sFail();

      if (mode==="daily"){
        lives = Math.max(0, lives - 1);
        msg.textContent = lives === 0 ? "Hakkın bitti. +2 hak reklam opsiyonel." : "Hata. Tekrar dene.";
      } else {
        msg.textContent = "Hata. Tekrar dene.";
      }
    }

    clampTol();
    render();
  }

  // ---------- Share Card ----------
  function makeShareText(){
    const diffLabel = diff==="easy"?"Kolay":diff==="med"?"Orta":"Zor";
    if (mode === "daily"){
      const best = load(bestKey(diff), 0);
      return `TimeFeel • Daily\nHedef: ${fmt2(DAILY[diff])}s (${diffLabel})\nEn iyi streak: ${best}\n${location.href}`;
    } else {
      return `TimeFeel • Practice\nHedef: ${fmt2(practiceTarget)}s (${diffLabel})\n${location.href}`;
    }
  }

  function drawShareCard(){
    const w = 1080, h = 1350;
    const c = document.createElement("canvas");
    c.width = w; c.height = h;
    const ctx = c.getContext("2d");

    // Background gradient
    const g = ctx.createLinearGradient(0, 0, 0, h);
    g.addColorStop(0, "#070912");
    g.addColorStop(0.6, "#06070e");
    g.addColorStop(1, "#05060b");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);

    // Soft blobs
    function blob(x,y,r, color){
      const rg = ctx.createRadialGradient(x,y,0,x,y,r);
      rg.addColorStop(0, color);
      rg.addColorStop(1, "rgba(0,0,0,0)");
      ctx.fillStyle = rg;
      ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    }
    blob(260,240,420,"rgba(120,120,255,0.20)");
    blob(840,220,460,"rgba(78,163,255,0.20)");
    blob(760,1040,520,"rgba(120,255,190,0.14)");

    // Card
    const pad = 70;
    const rx = 38;
    const cx = pad, cy = 140, cw = w - pad*2, ch = h - 240;
    roundRect(ctx, cx, cy, cw, ch, rx);
    ctx.fillStyle = "rgba(255,255,255,0.05)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.lineWidth = 2;
    ctx.stroke();

    // Title
    ctx.fillStyle = "rgba(255,255,255,0.75)";
    ctx.font = "700 28px ui-sans-serif, system-ui";
    ctx.fillText("TIMEFEEL", cx+46, cy+70);

    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.font = "900 56px ui-sans-serif, system-ui";
    ctx.fillText(mode === "daily" ? "DAILY" : "PRACTICE", cx+46, cy+140);

    const diffLabel = diff==="easy"?"Kolay":diff==="med"?"Orta":"Zor";
    const goalSec = mode==="daily" ? DAILY[diff] : practiceTarget;
    const best = load(bestKey(diff), 0);

    // Main numbers
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "900 64px ui-sans-serif, system-ui";
    ctx.fillText(`Hedef: ${fmt2(goalSec)}s`, cx+46, cy+250);

    ctx.fillStyle = "rgba(255,255,255,0.70)";
    ctx.font = "700 30px ui-sans-serif, system-ui";
    ctx.fillText(`Zorluk: ${diffLabel}`, cx+46, cy+305);

    ctx.fillStyle = "rgba(255,255,255,0.90)";
    ctx.font = "900 52px ui-sans-serif, system-ui";
    if (mode === "daily"){
      ctx.fillText(`En iyi streak: ${best}`, cx+46, cy+400);
    } else {
      ctx.fillText(`Streak: ${streak}`, cx+46, cy+400);
    }

    // Orb illustration
    const ox = cx + cw - 230;
    const oy = cy + 300;
    const or = 130;
    const og = ctx.createRadialGradient(ox-or/3, oy-or/3, 10, ox, oy, or);
    og.addColorStop(0, "rgba(78,163,255,0.55)");
    og.addColorStop(0.6, "rgba(78,163,255,0.18)");
    og.addColorStop(1, "rgba(255,255,255,0.03)");
    ctx.beginPath(); ctx.arc(ox, oy, or, 0, Math.PI*2); ctx.fillStyle = og; ctx.fill();
    ctx.strokeStyle = "rgba(78,163,255,0.45)"; ctx.lineWidth = 3; ctx.stroke();

    // Footer
    ctx.fillStyle = "rgba(255,255,255,0.55)";
    ctx.font = "700 26px ui-sans-serif, system-ui";
    ctx.fillText(`Tarih: ${todayKey()}`, cx+46, cy+ch-90);

    ctx.fillStyle = "rgba(255,255,255,0.45)";
    ctx.font = "700 22px ui-sans-serif, system-ui";
    ctx.fillText(`Oyna: ${shortUrl(location.href)}`, cx+46, cy+ch-50);

    return c;

    function roundRect(ctx,x,y,w,h,r){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,  x+w,y+h, r);
      ctx.arcTo(x+w,y+h,x,  y+h, r);
      ctx.arcTo(x,  y+h,x,  y,   r);
      ctx.arcTo(x,  y,  x+w,y,   r);
      ctx.closePath();
    }
    function shortUrl(u){
      try{
        const url = new URL(u);
        return url.host + url.pathname;
      }catch{
        return u;
      }
    }
  }

  async function shareScore(){
    const text = makeShareText();
    const canvas = drawShareCard();
    const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
    const file = blob ? new File([blob], "timefeel.png", { type: "image/png" }) : null;

    // Web Share API (mobil)
    try{
      if (navigator.share && file && navigator.canShare && navigator.canShare({ files: [file] })){
        await navigator.share({ title: "TimeFeel", text, files: [file] });
        msg.textContent = "Paylaşıldı.";
        return;
      }
      if (navigator.share){
        await navigator.share({ title: "TimeFeel", text });
        msg.textContent = "Paylaşıldı.";
        return;
      }
    }catch{
      // user cancelled or share failed — fallback to download
    }

    // Download fallback
    if (blob){
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "timefeel.png";
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 500);
      msg.textContent = "Görsel indirildi (paylaşabilirsin).";
    } else {
      msg.textContent = "Paylaşım oluşturulamadı.";
    }
  }

  // ---------- Buttons ----------
  function toggleSound(){
    soundOn = !soundOn;
    save("sound_on", soundOn);
    if (soundOn) ensureAudio();
    setActiveChips();
    msg.textContent = soundOn ? "Ses açıldı." : "Ses kapandı.";
    sSwitch();
  }

  function setMode(newMode){
    if (newMode !== "daily" && newMode !== "practice") return;
    mode = newMode;
    save("mode", mode);
    sSwitch();
    hardReset(false);
  }

  function setDiff(newDiff){
    if (!TOL[newDiff]) return;
    diff = newDiff;
    save("diff", diff);
    sSwitch();
    hardReset(false);
  }

  function setPracticeTarget(sec){
    practiceTarget = clamp(sec, 1.00, 2.20);
    save("practice_target", practiceTarget);
    if (mode==="practice") msg.textContent = "Hedef güncellendi.";
    render();
  }

  tabDaily.addEventListener("click", ()=> setMode("daily"));
  tabPractice.addEventListener("click", ()=> setMode("practice"));

  diffEasy.addEventListener("click", ()=> setDiff("easy"));
  diffMed.addEventListener("click", ()=> setDiff("med"));
  diffHard.addEventListener("click", ()=> setDiff("hard"));

  soundBtn.addEventListener("click", ()=> toggleSound());
  shareBtn.addEventListener("click", ()=> shareScore());

  resetBtn.addEventListener("click", ()=> { sSwitch(); hardReset(true); });

  adBtn.addEventListener("click", ()=>{
    if (mode!=="daily" || lives>0) return;
    lives = Math.min(LIVES_MAX, lives + 2);
    msg.textContent = "+2 hak aldın.";
    showToast("+2 LIFE", true);
    sNice();
    render();
  });

  randBtn.addEventListener("click", ()=>{
    const r = 1.00 + (2.20 - 1.00) * Math.random();
    setPracticeTarget(round2(r));
    sSwitch();
  });
  slider.addEventListener("input", (e)=> setPracticeTarget(parseFloat(e.target.value)));

  // pointer + space
  arena.addEventListener("pointerdown", (e)=>{ e.preventDefault(); onPress(); }, { passive:false });
  window.addEventListener("pointerup", ()=> onRelease(), { passive:true });

  window.addEventListener("keydown", (e)=>{ if (e.code==="Space"){ e.preventDefault(); onPress(); } });
  window.addEventListener("keyup", (e)=>{ if (e.code==="Space"){ e.preventDefault(); onRelease(); } });

  // ---------- Init ----------
  function init(){
    // normalize lives if someone refreshes at 0 (daily)
    if (mode === "daily" && typeof lives !== "number") lives = LIVES_MAX;
    setActiveChips();
    render();
    hardReset(false);
  }

  init();
})();
</script>
</body>
</html>
