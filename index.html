<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TimeFeel v1.3</title>
  <style>
    :root { color-scheme: dark; }
    * { -webkit-tap-highlight-color: transparent; }
    html, body {
      height:100%;
      margin:0;
      background:#070912;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      -webkit-touch-callout:none;
      -webkit-user-select:none;
      user-select:none;
      overflow-x:hidden;
    }

    .bg{
      position:fixed; inset:0;
      background:
        radial-gradient(1000px 700px at 20% 20%, rgba(120,120,255,0.16), transparent 60%),
        radial-gradient(1000px 700px at 80% 10%, rgba(78,163,255,0.16), transparent 55%),
        radial-gradient(900px 700px at 70% 80%, rgba(120,255,190,0.10), transparent 60%),
        linear-gradient(180deg, #070912 0%, #06070e 60%, #05060b 100%);
      filter:saturate(1.08);
    }
    .grain{
      pointer-events:none;
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.35'/%3E%3C/svg%3E");
      opacity:.04; mix-blend-mode:overlay;
    }
    .wrap{ position:relative; min-height:100%; display:flex; align-items:center; justify-content:center; padding:18px; }

    .card{
      width:min(880px,96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      box-shadow:0 22px 70px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.03) inset;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      padding:16px;
    }

    /* ---- Shared UI ---- */
    .orbWrap{ position:relative; width:180px; height:180px; display:flex; align-items:center; justify-content:center; }
    .ring{
      position:absolute; inset:-14px; border-radius:999px;
      border:1px solid rgba(255,255,255,0.07);
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.05), transparent 60%);
      pointer-events:none;
    }
    .orb{
      width:170px; height:170px; border-radius:999px;
      display:flex; align-items:center; justify-content:center;
      font-weight:950; letter-spacing:0.12em;
      border:1px solid rgba(78,163,255,0.45);
      background: radial-gradient(circle at 30% 30%, rgba(78,163,255,0.35), rgba(78,163,255,0.10) 40%, rgba(255,255,255,0.02));
      box-shadow:0 25px 70px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.04) inset;
      transition: transform 130ms ease, box-shadow 130ms ease, background 130ms ease;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none;
      pointer-events:auto;
      touch-action:none;
    }
    .orb.holding{
      transform:scale(1.06);
      background: radial-gradient(circle at 30% 30%, rgba(78,163,255,0.50), rgba(78,163,255,0.18) 45%, rgba(255,255,255,0.03));
      box-shadow:0 30px 90px rgba(0,0,0,0.62), 0 0 0 22px rgba(78,163,255,0.09);
    }
    .hint{ position:absolute; bottom:14px; font-size:12px; opacity:.6; pointer-events:none; }

    .toast{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:46px; font-weight:950;
      opacity:0; transform: translateY(8px);
      transition: opacity 160ms ease, transform 160ms ease;
      pointer-events:none;
      text-shadow:0 16px 60px rgba(0,0,0,0.70);
    }
    .toast.show{ opacity:1; transform:translateY(0); }
    .good{ color: rgba(120,255,190,0.95); }
    .bad{ color: rgba(255,120,140,0.95); }

    /* ---- Gate overlay ---- */
    #gateScreen{
      position:fixed; inset:0;
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;

      background: rgba(0,0,0,0.35);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      touch-action:none;

      opacity:1;
      transition: opacity 240ms ease;
    }
    #gateScreen.gone{ opacity:0; pointer-events:none; }
    #gateCard{
      width:min(560px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      box-shadow:0 22px 70px rgba(0,0,0,0.55), 0 0 0 1px rgba(255,255,255,0.03) inset;
      padding:16px;

      transform:scale(1);
      transition: transform 240ms ease, opacity 240ms ease;
      opacity:1;
    }
    #gateScreen.gone #gateCard{ transform:scale(0.985); opacity:0; }
    .gateTitle{ font-size:12px; opacity:.65; letter-spacing:.18em; text-transform:uppercase; }
    .gateGoal{ margin-top:10px; font-size:34px; font-weight:950; line-height:1.12; }
    .gateSub{ margin-top:8px; font-size:13px; opacity:.72; }
    .gateArena{
      margin-top:14px;
      height:300px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.10);
      background: radial-gradient(800px 320px at 50% 0%, rgba(78,163,255,0.14), rgba(255,255,255,0.01));
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
      touch-action:none;
      pointer-events:auto;
    }

    /* ---- Main app (hidden until gate passes) ---- */
    #mainApp{
      display:none;
      opacity:0;
      transform: translateY(8px) scale(0.995);
      transition: opacity 260ms ease, transform 260ms ease;
    }
    #mainApp.show{
      opacity:1;
      transform: translateY(0) scale(1);
    }

    .top{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .brandRow{ display:flex; align-items:center; gap:10px; }
    .logo{
      width:34px; height:34px; border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: radial-gradient(18px 18px at 30% 30%, rgba(78,163,255,0.35), rgba(255,255,255,0.02));
      box-shadow:0 10px 30px rgba(0,0,0,0.35);
      display:flex; align-items:center; justify-content:center;
    }
    .headline{ font-size:22px; font-weight:950; letter-spacing:0.01em; line-height:1.15; }
    .mini{ font-size:12px; opacity:.62; line-height:1.35; }

    .controls{ display:flex; flex-direction:column; gap:8px; align-items:flex-end; }
    .chipRow{ display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; }
    .chip{
      appearance:none;
      border-radius:999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      color: rgba(255,255,255,0.92);
      font-weight:900;
      font-size:12px;
      cursor:pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    .chip:hover{ transform:translateY(-1px); }
    .chip:active{ transform:translateY(0) scale(0.99); }
    .chip.active{
      border-color: rgba(78,163,255,0.38);
      background: rgba(78,163,255,0.14);
      box-shadow:0 10px 30px rgba(78,163,255,0.08);
    }

    .stats{ margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
      white-space:nowrap; opacity:.94;
    }
    .pill b{ font-weight:950; }
    .dot{ width:6px; height:6px; border-radius:999px; background: rgba(255,255,255,0.35); }
    .dot.green{ background: rgba(120,255,190,0.75); }
    .dot.blue{ background: rgba(78,163,255,0.75); }
    .dot.red{ background: rgba(255,120,140,0.80); }

    .arena{
      margin-top:14px; height:360px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.08);
      background:
        radial-gradient(900px 380px at 50% 0%, rgba(78,163,255,0.14), rgba(255,255,255,0.01)),
        radial-gradient(700px 420px at 50% 120%, rgba(120,255,190,0.08), transparent 65%);
      display:flex; align-items:center; justify-content:center;
      position:relative; overflow:hidden;
      touch-action:none;
    }

    .bottom{ margin-top:14px; display:grid; grid-template-columns: 1.15fr 0.85fr; gap:12px; }
    @media (max-width:820px){
      .controls{ align-items:flex-start; }
      .chipRow{ justify-content:flex-start; }
      .bottom{ grid-template-columns:1fr; }
      .arena{ height:330px; }
    }
    .panel{
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.025);
      padding:12px;
      box-shadow: 0 0 0 1px rgba(255,255,255,0.02) inset;
    }
    .panel h3{ margin:0 0 8px 0; font-size:12px; opacity:.65; letter-spacing:.12em; text-transform:uppercase; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .metric{ display:flex; flex-direction:column; gap:4px; min-width:120px; }
    .metric .k{ font-size:11px; opacity:.55; letter-spacing:.06em; text-transform:uppercase; }
    .metric .v{ font-size:18px; font-weight:950; }

    .btn{
      appearance:none; border-radius:14px;
      padding:10px 12px; font-weight:950; font-size:13px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.92);
      cursor:pointer;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0) scale(0.99); }
    .btn.primary{
      border-color: rgba(78,163,255,0.38);
      background: rgba(78,163,255,0.14);
      box-shadow: 0 12px 40px rgba(78,163,255,0.08);
    }
    .btn:disabled{ opacity:.45; cursor:not-allowed; }

    .lbItem{ display:flex; justify-content:space-between; gap:10px; font-size:13px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.06); }
    .lbItem:last-child{ border-bottom:none; }

    .confetti{
      position:absolute; width:8px; height:10px; border-radius:2px; opacity:0.95; pointer-events:none;
      transform: translateY(-20px);
      animation: fall 720ms ease-out forwards;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,0.55));
    }
    @keyframes fall{ to{ transform: translateY(380px) rotate(220deg); opacity:0; } }

    input[type="range"]{ width:100%; }

    .footer{ margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; font-size:12px; opacity:.5; }
  </style>
</head>

<body tabindex="0">
  <div class="bg"></div>
  <div class="grain"></div>

  <!-- GATE -->
  <div id="gateScreen">
    <div id="gateCard">
      <div class="gateTitle">GİRİŞ TESTİ</div>
      <div class="gateGoal" id="gateGoal">Hedef: 1.20s</div>
      <div class="gateSub" id="gateMsg">Basılı tut → hedefte bırak. (Space)</div>

      <div class="gateArena" id="gateArena">
        <div class="toast" id="gateToast">OK</div>
        <div class="orbWrap">
          <div class="ring" aria-hidden="true"></div>
          <div class="orb" id="gateOrb" aria-label="Hold">HOLD</div>
        </div>
        <div class="hint">Basılı tut / bırak • Space</div>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="wrap">
    <div class="card" id="mainApp">
      <div class="top">
        <div class="brandRow">
          <div class="logo" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M12 2v3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 19v3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M4.93 4.93l2.12 2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M16.95 16.95l2.12 2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M2 12h3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M19 12h3" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M4.93 19.07l2.12-2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M16.95 7.05l2.12-2.12" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 7a5 5 0 1 0 0 10" stroke="rgba(255,255,255,.85)" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </div>
          <div>
            <div class="headline" id="goalLine">Bugünün hedefi: 6.20s (Orta)</div>
            <div class="mini" id="miniModeLine" style="margin-top:6px;">Daily • Orta</div>
          </div>
        </div>

        <div class="controls">
          <div class="chipRow">
            <button class="chip" id="tabDaily" type="button">Daily</button>
            <button class="chip" id="tabPractice" type="button">Practice</button>
            <button class="chip" id="shareBtn" type="button">Share</button>
          </div>
          <div class="chipRow">
            <button class="chip" id="diffEasy" type="button">Kolay</button>
            <button class="chip" id="diffMed" type="button">Orta</button>
            <button class="chip" id="diffHard" type="button">Zor</button>
            <button class="chip" id="soundBtn" type="button">Ses: Açık</button>
          </div>
        </div>
      </div>

      <div class="stats" id="statsBar">
        <div class="pill" id="pillLives"><span class="dot red"></span> Hak <b id="lives">5</b></div>
        <div class="pill"><span class="dot green"></span> Streak <b id="streak">0</b></div>
        <div class="pill" id="pillBest"><span class="dot blue"></span> Best <b id="best">0</b></div>
        <div class="pill"><span class="dot blue"></span> Tolerans <b id="tolLabel">± 150 ms</b></div>
      </div>

      <div class="arena" id="arena">
        <div class="toast" id="toast">PERFECT</div>
        <div class="orbWrap">
          <div class="ring" aria-hidden="true"></div>
          <div class="orb" id="orb" aria-label="Hold">HOLD</div>
        </div>
        <div class="hint">Basılı tut / bırak (Space da olur)</div>
      </div>

      <div class="bottom">
        <div class="panel">
          <h3>Son deneme</h3>
          <div class="row">
            <div class="metric"><div class="k">Sen</div><div class="v" id="lastYou">—</div></div>
            <div class="metric"><div class="k">Hedef</div><div class="v" id="lastGoal">—</div></div>
            <div class="metric"><div class="k">Fark</div><div class="v" id="lastDiff">—</div></div>
            <div class="metric"><div class="k">Sonuç</div><div class="v" id="lastVerdict">—</div></div>
          </div>

          <div class="mini" style="margin-top:10px;" id="msg">Hazır.</div>

          <div class="row" style="margin-top:12px;">
            <button class="btn" id="resetBtn" type="button">Sıfırla</button>
            <button class="btn primary" id="adBtn" type="button">+2 Hak</button>
          </div>

          <div id="practiceBox" style="display:none; margin-top:12px;">
            <div class="row" style="align-items:center;">
              <div class="pill">Practice hedefi: <b id="pVal">0.00s</b></div>
              <button class="btn" id="randBtn" type="button">Random</button>
            </div>
            <div style="margin-top:10px;">
              <input id="slider" type="range" min="0.00" max="20.00" step="0.01" value="6.20" />
              <div class="mini" style="margin-top:8px;">0.00–20.00 saniye</div>
            </div>
          </div>
        </div>

        <div class="panel" id="lbPanel">
          <h3>Daily leaderboard</h3>
          <div id="lb"></div>
          <div class="mini" style="margin-top:10px;">Sadece bu tarayıcıda saklanır.</div>
        </div>
      </div>

      <div class="footer">
        <div>Daily: 5 hak • Practice: sınırsız</div>
        <div>v1.3 + Gate</div>
      </div>
    </div>
  </div>

<script>
(() => {
  // iOS/Safari: long-press context menu + selection engelle
  window.addEventListener("contextmenu", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("selectstart", (e)=>e.preventDefault(), {passive:false});
  document.addEventListener("gesturestart", (e)=>e.preventDefault(), {passive:false});

  // Focus fix: Space daha stabil gelsin
  function forceFocus(){
    try{ document.body.focus({preventScroll:true}); window.focus(); }catch{}
  }
  window.addEventListener("pointerdown", forceFocus, {passive:true});
  window.addEventListener("touchstart", forceFocus, {passive:true});
  window.addEventListener("click", forceFocus, {passive:true});
  forceFocus();

  // ---------- TTS (komik replikler) ----------
  const WIN_LINES = ["İşte bu!", "Çok temiz!", "Tam ayarında!", "Bayağı iyiydi!", "Aynen böyle!"];
  const PERFECT_LINES = ["Efsane!", "Bu ne netlik!", "Usta işi!", "Makine gibi!", "Ders niteliğinde!"];
  const LOSE_LINES = ["Ah be!", "Bir tık kaçtı!", "Olmadı bu!", "Neredeyseydi!", "Göz kararı zor iş!"];
  const GATE_FAIL_LINES = ["Isınma turu!", "Daha iyisini yaparsın!", "Bir daha dene!", "Bu sefer olmadı!", "Hadi toparla!"];

  function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

  function speakTR(text){
    if (!soundOn) return; // Ses: Kapalı ise TTS de kapalı
    if (!("speechSynthesis" in window)) return;
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "tr-TR";
      u.rate = 1.05;
      u.pitch = 1.05;
      u.volume = 1.0;
      const voices = window.speechSynthesis.getVoices?.() || [];
      const tr = voices.find(v => (v.lang || "").toLowerCase().startsWith("tr"));
      if (tr) u.voice = tr;
      window.speechSynthesis.speak(u);
    }catch{}
  }
  window.speechSynthesis?.getVoices?.();
  window.addEventListener("pointerdown", ()=>window.speechSynthesis?.getVoices?.(), {once:true});

  // ---------- Helpers ----------
  function todayKey(){
    const d=new Date();
    const yyyy=d.getFullYear();
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function round2(x){ return Math.round(x*100)/100; }
  function fmt2(x){ return x.toFixed(2); }
  function signedMs(x){
    const n=Math.round(x);
    return (n>=0?"+":"")+n+"ms";
  }
  function fmtSecDynamic(sec){ return sec<10 ? sec.toFixed(2) : sec.toFixed(1); }
  function seededFloat01(seedStr){
    let h=2166136261;
    for (let i=0;i<seedStr.length;i++){ h^=seedStr.charCodeAt(i); h=Math.imul(h,16777619); }
    return (h>>>0)/4294967296;
  }

  // ---------- Daily goals (5–8s) ----------
  function dailyGoals(){
    const b1=seededFloat01("timefeel:v13:"+todayKey());
    const b2=seededFloat01("timefeel:v13b:"+todayKey());
    const b3=seededFloat01("timefeel:v13c:"+todayKey());
    const snap05 = (x)=> Math.round(x/0.05)*0.05;
    const easy = round2(clamp(snap05(5+3*b1), 5, 8));
    const med  = round2(clamp(snap05(5+3*b2), 5, 8));
    const hard = round2(clamp(snap05(5+3*b3), 5, 8));
    if (new Set([easy,med,hard]).size < 3) return {easy, med, hard: round2(clamp(hard+0.05, 5, 8))};
    return {easy, med, hard};
  }
  const DAILY = dailyGoals();

  // ---------- Tolerances ----------
  const TOL = {
    easy: { start: 180, min: 90, max: 320 },
    med:  { start: 150, min: 80, max: 280 },
    hard: { start: 120, min: 70, max: 240 },
  };

  // Gate: 0.30–3.00s + yüksek tolerans
  const GATE_TOL_MS = 260;
  const GATE_PERF_MS = 110;

  // ---------- Storage ----------
  const LS="timefeel_v13:";
  const load=(k,fb)=>{ try{ const v=localStorage.getItem(LS+k); return v?JSON.parse(v):fb; }catch{ return fb; } };
  const save=(k,v)=>{ try{ localStorage.setItem(LS+k, JSON.stringify(v)); }catch{} };

  // ---------- State ----------
  let mode = load("mode","daily");
  let diff = load("diff","med");
  if (!TOL[diff]) diff="med";
  if (mode!=="daily" && mode!=="practice") mode="daily";

  const LIVES_MAX=5;
  let lives=LIVES_MAX;
  let streak=0;
  let tolMs=TOL[diff].start;

  let practiceTarget = clamp(Number(load("practice_target", 6.20)) || 6.20, 0, 20);

  // Main hold
  let holding=false;
  let startMs=0;

  // Gate hold
  let gateTarget=0;
  let gateHolding=false;
  let gateStartMs=0;

  // Gate state
  let inGate = true;

  // ---------- Sound (beep) ----------
  let soundOn = load("sound_on", true);
  let audioCtx=null;

  function ensureAudio(){
    if (!soundOn) return null;
    if (!audioCtx){
      try{ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); }catch{ audioCtx=null; }
    }
    if (audioCtx && audioCtx.state==="suspended") audioCtx.resume().catch(()=>{});
    return audioCtx;
  }
  function tone(freq,dur,type="sine",gain=0.06){
    const ctx=ensureAudio(); if (!ctx) return;
    const t0=ctx.currentTime;
    const osc=ctx.createOscillator();
    const g=ctx.createGain();
    osc.type=type; osc.frequency.setValueAtTime(freq,t0);
    g.gain.setValueAtTime(0.0001,t0);
    g.gain.exponentialRampToValueAtTime(gain,t0+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001,t0+dur);
    osc.connect(g); g.connect(ctx.destination);
    osc.start(t0); osc.stop(t0+dur+0.02);
  }
  const sPress=()=>tone(180,0.07,"sine",0.05);
  const sNice=()=>{ tone(520,0.08,"triangle",0.06); setTimeout(()=>tone(760,0.09,"triangle",0.035),20); };
  const sPerfect=()=>{ tone(620,0.08,"triangle",0.06); setTimeout(()=>tone(880,0.10,"triangle",0.05),60); };
  const sFail=()=>{ tone(140,0.10,"sawtooth",0.045); setTimeout(()=>tone(110,0.10,"sawtooth",0.035),70); };
  const sSwitch=()=>tone(320,0.05,"sine",0.04);

  // ---------- DOM ----------
  const $=(id)=>document.getElementById(id);

  const gateScreen=$("gateScreen");
  const gateGoal=$("gateGoal");
  const gateMsg=$("gateMsg");
  const gateArena=$("gateArena");
  const gateOrb=$("gateOrb");
  const gateToast=$("gateToast");
  const gateCard=$("gateCard");

  const mainApp=$("mainApp");

  const tabDaily=$("tabDaily");
  const tabPractice=$("tabPractice");
  const shareBtn=$("shareBtn");
  const soundBtn=$("soundBtn");
  const diffEasy=$("diffEasy");
  const diffMed=$("diffMed");
  const diffHard=$("diffHard");

  const goalLine=$("goalLine");
  const miniModeLine=$("miniModeLine");

  const pillLives=$("pillLives");
  const livesEl=$("lives");
  const streakEl=$("streak");
  const pillBest=$("pillBest");
  const bestEl=$("best");
  const tolLabel=$("tolLabel");

  const arena=$("arena");
  const orb=$("orb");
  const toast=$("toast");

  const lastYou=$("lastYou");
  const lastGoal=$("lastGoal");
  const lastDiff=$("lastDiff");
  const lastVerdict=$("lastVerdict");
  const msg=$("msg");

  const resetBtn=$("resetBtn");
  const adBtn=$("adBtn");

  const practiceBox=$("practiceBox");
  const pVal=$("pVal");
  const randBtn=$("randBtn");
  const slider=$("slider");

  const lbPanel=$("lbPanel");
  const lb=$("lb");

  // ---------- UI helpers ----------
  function showToast(el, text, good){
    el.textContent=text;
    el.className="toast show "+(good?"good":"bad");
    setTimeout(()=> el.className="toast", 520);
  }
  function setHolding(el,on){
    el.classList.toggle("holding", on);
    el.textContent = on ? "…" : "HOLD";
  }

  function confettiBurst(count=14){
    const rect=arena.getBoundingClientRect();
    for (let i=0;i<count;i++){
      const el=document.createElement("div");
      el.className="confetti";
      el.style.left=`${rect.width*(0.25+Math.random()*0.5)}px`;
      el.style.top="0px";
      el.style.background=`hsl(${Math.floor(Math.random()*360)} 90% 70%)`;
      el.style.animationDuration=`${640+Math.random()*240}ms`;
      arena.appendChild(el);
      setTimeout(()=> el.remove(), 950);
    }
  }

  // ---------- Gate ----------
  function newGateTarget(){
    const raw = 0.3 + Math.random()*2.7;
    const snap = Math.round(raw/0.05)*0.05;
    gateTarget = clamp(snap, 0.3, 3.0);
    gateGoal.textContent = `Hedef: ${gateTarget.toFixed(2)}s`;
    gateMsg.textContent  = "Basılı tut → hedefte bırak. (Space)";
  }

  function passGate(){
    inGate=false;
    gateScreen.classList.add("gone");
    mainApp.style.display="block";
    requestAnimationFrame(()=> mainApp.classList.add("show"));
    setTimeout(()=>{ gateScreen.style.display="none"; }, 260);
    render();
    hardReset(false);
  }

  function gatePress(e){
    ensureAudio();
    if (!inGate || gateHolding) return;

    // pointer capture (mouse/touch stabil)
    try{
      if (e && e.pointerId != null && gateScreen.setPointerCapture) gateScreen.setPointerCapture(e.pointerId);
    }catch{}

    gateHolding=true;
    gateStartMs=performance.now();
    setHolding(gateOrb,true);
    sPress();
  }

  function gateRelease(){
    if (!gateHolding) return;
    gateHolding=false;
    setHolding(gateOrb,false);

    const elapsedMs = performance.now() - gateStartMs;
    const diffMs    = elapsedMs - (gateTarget*1000);
    const abs       = Math.abs(diffMs);

    // ✅ burada da süre yaz
    gateMsg.textContent = `Sen: ${(elapsedMs/1000).toFixed(2)}s • Fark: ${signedMs(diffMs)}`;

    if (abs <= GATE_TOL_MS){
      const txt = (abs <= GATE_PERF_MS) ? "PERFECT" : "OK";
      showToast(gateToast, txt, true);
      sPerfect();
      speakTR(abs <= GATE_PERF_MS ? rand(PERFECT_LINES) : rand(WIN_LINES));
      setTimeout(passGate, 260);
    } else {
      const txt = diffMs < 0 ? "EARLY" : "LATE";
      showToast(gateToast, txt, false);
      sFail();
      speakTR(rand(GATE_FAIL_LINES));
      setTimeout(newGateTarget, 520);
    }
  }

  // ---------- Main game ----------
  function currentGoalSec(){ return mode==="daily" ? DAILY[diff] : practiceTarget; }
  function clampTol(){ tolMs = clamp(tolMs, TOL[diff].min, TOL[diff].max); }

  function setActiveChips(){
    tabDaily.classList.toggle("active", mode==="daily");
    tabPractice.classList.toggle("active", mode==="practice");
    diffEasy.classList.toggle("active", diff==="easy");
    diffMed.classList.toggle("active", diff==="med");
    diffHard.classList.toggle("active", diff==="hard");
    soundBtn.classList.toggle("active", soundOn);
    soundBtn.textContent = soundOn ? "Ses: Açık" : "Ses: Kapalı";
  }

  const bestKey=(d)=>`best:${todayKey()}:${d}`;
  let history = load("history", []);

  function upsertHistory(){
    const t=todayKey();
    for (const d of ["easy","med","hard"]){
      const best=load(bestKey(d),0);
      const ex=history.find(x=>x.date===t && x.diff===d);
      if (ex){ ex.goal=DAILY[d]; ex.best=Math.max(ex.best||0, best); }
      else history.unshift({date:t,diff:d,goal:DAILY[d],best});
    }
    const trimmed=[];
    const counts={easy:0,med:0,hard:0};
    for (const item of history){
      if (counts[item.diff] < 7){ trimmed.push(item); counts[item.diff]++; }
      if (trimmed.length>=21) break;
    }
    history=trimmed; save("history", history);
  }

  function renderLB(){
    upsertHistory();
    const items=history.filter(x=>x.diff===diff).slice(0,7);
    lb.innerHTML="";
    if (!items.length){ lb.innerHTML='<div class="mini">Henüz veri yok.</div>'; return; }
    for (const it of items){
      const row=document.createElement("div");
      row.className="lbItem";
      const left=document.createElement("div");
      left.innerHTML=`<div style="font-weight:950;">${it.date}</div><div class="mini" style="opacity:.65;">Hedef: ${fmt2(it.goal)}s</div>`;
      const right=document.createElement("div");
      right.style.fontWeight="950";
      right.textContent=String(it.best||0);
      row.appendChild(left); row.appendChild(right);
      lb.appendChild(row);
    }
  }

  function resetAttemptUI(){
    lastYou.textContent="—";
    lastGoal.textContent="—";
    lastDiff.textContent="—";
    lastVerdict.textContent="—";
  }

  function render(){
    setActiveChips();
    const diffLabel = diff==="easy"?"Kolay":diff==="med"?"Orta":"Zor";
    miniModeLine.textContent = (mode==="daily" ? "Daily" : "Practice") + " • " + diffLabel;

    if (mode==="daily") goalLine.textContent = `Bugünün hedefi: ${fmt2(DAILY[diff])}s (${diffLabel})`;
    else goalLine.textContent = `Hedef: ${fmtSecDynamic(practiceTarget)}s (${diffLabel})`;

    pillLives.style.display = mode==="daily" ? "inline-flex" : "none";
    pillBest.style.display  = mode==="daily" ? "inline-flex" : "none";
    lbPanel.style.display   = mode==="daily" ? "block" : "none";
    adBtn.style.display     = mode==="daily" ? "inline-flex" : "none";
    practiceBox.style.display = mode==="practice" ? "block" : "none";

    livesEl.textContent=String(lives);
    streakEl.textContent=String(streak);
    tolLabel.textContent = `± ${Math.round(tolMs)} ms`;

    if (mode==="daily"){
      bestEl.textContent=String(load(bestKey(diff),0));
      adBtn.disabled = !(lives<=0);
      renderLB();
    }
    slider.value=String(practiceTarget);
    pVal.textContent = `${fmtSecDynamic(practiceTarget)}s`;
  }

  function hardReset(refillLives){
    holding=false;
    setHolding(orb,false);
    streak=0;
    tolMs=TOL[diff].start;
    clampTol();
    if (mode==="daily" && refillLives) lives=LIVES_MAX;
    msg.textContent="Hazır.";
    resetAttemptUI();
    render();
  }

  function onPress(){
    ensureAudio();
    if (holding) return;
    if (inGate) return;

    if (mode==="daily" && lives<=0){
      msg.textContent="Hakkın bitti. +2 hak al.";
      showToast(toast, "NO LIVES", false);
      sFail();
      speakTR("Hakkın bitti!");
      return;
    }

    holding=true;
    startMs=performance.now();
    setHolding(orb,true);
    msg.textContent="Tutuyorsun…";
    sPress();
  }

  function onRelease(){
    if (!holding) return;
    holding=false;
    setHolding(orb,false);

    const elapsedMs=performance.now()-startMs;
    const elapsedSec=elapsedMs/1000;

    const goalSec=currentGoalSec();
    const diffMs=elapsedMs-(goalSec*1000);
    const abs=Math.abs(diffMs);

    lastYou.textContent=`${fmtSecDynamic(elapsedSec)}s`;
    lastGoal.textContent=`${fmtSecDynamic(goalSec)}s`;
    lastDiff.textContent=signedMs(diffMs);

    const ok = abs <= tolMs;
    const perfect = abs <= tolMs * 0.35;

    if (ok){
      streak += 1;
      if (streak % 5 === 0) tolMs -= (diff==="hard"?10:diff==="easy"?7:8);
      lastVerdict.textContent = perfect ? "PERFECT" : "NICE";
      showToast(toast, lastVerdict.textContent, true);
      msg.textContent="Başarılı!";
      if (perfect){
        confettiBurst(14);
        sPerfect();
        speakTR(rand(PERFECT_LINES));
      } else {
        sNice();
        speakTR(rand(WIN_LINES));
      }

      if (mode==="daily"){
        const k=bestKey(diff);
        const b=load(k,0);
        if (streak>b) save(k, streak);
      }
    } else {
      streak=0;
      tolMs += (diff==="hard"?10:diff==="easy"?7:8);
      lastVerdict.textContent = diffMs < 0 ? "EARLY" : "LATE";
      showToast(toast, lastVerdict.textContent, false);
      sFail();
      speakTR(rand(LOSE_LINES));

      if (mode==="daily"){
        lives=Math.max(0, lives-1);
        msg.textContent = lives===0 ? "Hakkın bitti. +2 hak al." : "Hata. Tekrar dene.";
      } else msg.textContent="Hata. Tekrar dene.";
    }

    clampTol();
    render();
  }

  // ---------- Share ----------
  function makeShareText(){
    const diffLabel = diff==="easy"?"Kolay":diff==="med"?"Orta":"Zor";
    if (mode==="daily"){
      const best=load(bestKey(diff),0);
      return `TimeFeel • Daily\nHedef: ${fmt2(DAILY[diff])}s (${diffLabel})\nEn iyi streak: ${best}\n${location.href}`;
    } else {
      return `TimeFeel • Practice\nHedef: ${fmtSecDynamic(practiceTarget)}s (${diffLabel})\n${location.href}`;
    }
  }
  async function shareScore(){
    const text = makeShareText();
    try{
      if (navigator.share){
        await navigator.share({ title:"TimeFeel", text });
        msg.textContent="Paylaşıldı.";
        return;
      }
    }catch{}
    try{
      await navigator.clipboard.writeText(text);
      msg.textContent="Kopyalandı.";
    }catch{
      msg.textContent="Paylaşım desteklenmiyor.";
    }
  }

  // ---------- Mode controls ----------
  function setMode(newMode){
    if (newMode!=="daily" && newMode!=="practice") return;
    mode=newMode; save("mode", mode); sSwitch(); hardReset(false);
  }
  function setDiff(newDiff){
    if (!TOL[newDiff]) return;
    diff=newDiff; save("diff", diff); sSwitch(); hardReset(false);
  }
  function setPracticeTarget(sec){
    practiceTarget=clamp(sec,0,20);
    save("practice_target", practiceTarget);
    if (mode==="practice") msg.textContent="Hedef güncellendi.";
    render();
  }
  function toggleSound(){
    soundOn=!soundOn; save("sound_on", soundOn);
    if (soundOn) ensureAudio();
    setActiveChips();
    msg.textContent = soundOn ? "Ses açıldı." : "Ses kapandı.";
    sSwitch();
  }

  // ---------- Buttons ----------
  tabDaily.addEventListener("click", ()=>setMode("daily"));
  tabPractice.addEventListener("click", ()=>setMode("practice"));
  diffEasy.addEventListener("click", ()=>setDiff("easy"));
  diffMed.addEventListener("click", ()=>setDiff("med"));
  diffHard.addEventListener("click", ()=>setDiff("hard"));
  soundBtn.addEventListener("click", ()=>toggleSound());
  shareBtn.addEventListener("click", ()=>shareScore());

  resetBtn.addEventListener("click", ()=>{ sSwitch(); hardReset(true); });
  adBtn.addEventListener("click", ()=>{
    if (mode!=="daily" || lives>0) return;
    lives=Math.min(LIVES_MAX, lives+2);
    msg.textContent="+2 hak aldın.";
    showToast(toast, "+2 LIFE", true);
    sNice(); speakTR("Devam!"); render();
  });

  randBtn.addEventListener("click", ()=>{
    const r=Math.random()*20;
    setPracticeTarget(round2(r));
    sSwitch();
  });
  slider.addEventListener("input", (e)=> setPracticeTarget(parseFloat(e.target.value)));

  // ---------- Inputs routing (Gate + Main) ----------
  function bindGatePointer(el){
    el.addEventListener("pointerdown", (e)=>{
      if (!inGate) return;
      e.preventDefault();
      gatePress(e);
    }, {passive:false});
  }
  // gate’te her yerden basılsın
  bindGatePointer(gateScreen);
  bindGatePointer(gateCard);
  bindGatePointer(gateArena);
  bindGatePointer(gateOrb);

  // main
  arena.addEventListener("pointerdown", (e)=>{
    if (inGate) return;
    e.preventDefault();
    onPress();
  }, {passive:false});

  window.addEventListener("pointerup", ()=>{
    if (inGate) gateRelease();
    else onRelease();
  }, {passive:true});

  window.addEventListener("keydown", (e)=>{
    if (e.code!=="Space") return;
    e.preventDefault();
    if (e.repeat) return;
    forceFocus();
    if (inGate) gatePress(null);
    else onPress();
  });
  window.addEventListener("keyup", (e)=>{
    if (e.code!=="Space") return;
    e.preventDefault();
    if (inGate) gateRelease();
    else onRelease();
  });

  // ---------- Init ----------
  newGateTarget();
  // Gate geçince main açılacak, ama state’i şimdiden çizelim
  render();
})();
</script>
</body>
</html>
